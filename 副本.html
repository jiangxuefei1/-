<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç¬¬ä¸€ç« ï¼ˆæç®€åŠ¨ç”»ç‰ˆ Â· é›¶æ»šåŠ¨ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#000000">
  <style>
    /* =========================================================
       åŸºç¡€é‡ç½®ä¸â€œé›¶æ»šåŠ¨â€ç­–ç•¥
       - é€šè¿‡æ ¹çº§ overflow: hidden ç¦æ­¢æ–‡æ¡£æ»šåŠ¨
       - é€šè¿‡å›ºå®šè§†å£å®¹å™¨æ‰¿æ‹…å®‰å…¨åŒºä¸å†…è¾¹è·ï¼Œé¿å…æ¨é«˜æ–‡æ¡£
       - é€šè¿‡ JS å†™å…¥ --vh = innerHeight/100ï¼Œç¨³å®šç§»åŠ¨ç«¯è§†å£
       ========================================================= */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    html, body {
      height: 100%;
      overflow: hidden;                  /* ç¦æ­¢æ»šåŠ¨ï¼ˆæ ¹çº§ï¼‰ */
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
    }

    :root{
      --vh: 1vh;                         /* JS ä¼šæ›´æ–°ä¸º innerHeightï¼Œé¿å…åœ°å€æ å½±å“ */
      --pad: clamp(16px, 4vw, 32px);
      --stage-max-w: 44rem;
    }
    /* ä¼˜å…ˆä½¿ç”¨æ›´ç²¾ç¡®çš„ dvh/svhï¼ˆæµè§ˆå™¨æ”¯æŒåˆ™è¦†ç›–ï¼‰ */
    @supports (height: 100dvh) { :root { --vh: 1dvh; } }
    @supports (height: 100svh) { :root { --vh: 1svh; } }

    /* =========================================================
       å›ºå®šè§†å£å±‚ï¼ˆå…³é”®ï¼‰
       - æ‰€æœ‰å¯è§å†…å®¹éƒ½æ”¾åœ¨ .viewport å†…ï¼Œé¿å…æ–‡æ¡£é«˜åº¦å˜åŒ–
       ========================================================= */
    .viewport{
      position: fixed; left: 0; top: 0; width: 100vw; height: calc(var(--vh) * 100);
      padding:
        calc(max(var(--pad), env(safe-area-inset-top)))
        calc(max(var(--pad), env(safe-area-inset-right)))
        calc(max(var(--pad), env(safe-area-inset-bottom)))
        calc(max(var(--pad), env(safe-area-inset-left)));
      display: grid; place-items: center;
      background: #000; color: #fff;
      overflow: hidden; overscroll-behavior: none;
    }

    /* åŸºç¡€æ’ç‰ˆï¼ˆé€‚åº¦å“åº”å¼å­—å·ï¼‰ */
    html { font-size: clamp(16px, 1.6vw + 0.5rem, 20px); }
    body { font-family: Georgia, serif; }

    a { color: #7fb7ff; text-decoration: none; display: block; margin: .5em 0; font-weight: bold; }
    a:hover { color: #bfe0ff; }
    a:focus-visible { outline: 2px solid currentColor; outline-offset: 2px; }

    /* èˆå°ï¼šç­‰æ¯”ç¼©æ”¾ä»¥é€‚é…é«˜åº¦ï¼ˆç”¨ JS åŠ¨æ€è®¡ç®— scaleï¼‰ */
    .stage{ max-width: var(--stage-max-w); width: min(100%, var(--stage-max-w)); transform-origin: top center; }
    .scene{ line-height: 1.65; }
    .muted{ opacity: .85; }

    /* åŠ¨ç”»ï¼ˆä¸ºâ€œå‡å°‘åŠ¨æ€â€ç”¨æˆ·é™çº§åˆ°æçŸ­å‡ºç°ï¼‰ */
    @keyframes appear { from { opacity: 0 } to { opacity: 1 } }
    @keyframes fadeOut { from { opacity: 1 } to { opacity: 0 } }
    @keyframes slideUpIn { from { transform: translateY(1.2em); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
    @keyframes slideLeftIn { from { transform: translateX(1.2em); opacity: 0 } to { transform: translateX(0); opacity: 1 } }
    @keyframes slideRightOut { from { transform: translateX(0); opacity: 1 } to { transform: translateX(-1.2em); opacity: 0 } }
    @keyframes flicker {
      0%,18%,22%,25%,53%,57%,100%{opacity:1}
      20%,24%,55%{opacity:.4}
      23%{opacity:.7}
    }
    @keyframes buoy { 25%{ top:.25em } 75%{ top:-.25em } 0%,100%{ top:0 } }
    @keyframes sway { 25%{ left:.25em } 75%{ left:-.25em } 0%,100%{ left:0 } }

    .t-enter{ animation: appear .45s ease both; }
    .t-enter-up{ animation: slideUpIn .5s ease both; }
    .t-enter-left{ animation: slideLeftIn .5s ease both; }
    .t-leave{ animation: fadeOut .3s ease both; }
    .t-leave-left{ animation: slideRightOut .35s ease both; }

    @media (prefers-reduced-motion: reduce){
      .t-enter, .t-enter-up, .t-enter-left, .t-leave, .t-leave-left { animation: appear .01s linear both; }
    }

    /* æç¯æ•ˆæœï¼ˆå¦‚éœ€åœ¨æ–‡æ¡ˆä¸­åŒ…è£¹ .lanternï¼‰ */
    .lantern{
      display: inline-block; position: relative;
      animation: flicker 2.2s infinite, buoy 3.2s ease-in-out infinite, sway 4.5s ease-in-out infinite;
    }

    /* è¿”å›æŒ‰é’®ï¼ˆå›ºå®šäºå®‰å…¨åŒºå†…ï¼‰ */
    .back-btn{
      position: fixed; left: calc(env(safe-area-inset-left) + 8px); top: calc(env(safe-area-inset-top) + 8px);
      background: #131313; border: 1px solid #333; border-radius: .6rem;
      color: #bfe0ff; padding: .45rem .7rem; font-weight: 700; cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,.35); z-index: 10;
      backdrop-filter: saturate(140%) blur(4px);
    }

     /* éŸ³ä¹æŒ‰é’® */
      .music-btn{
      position: fixed;
      right: 8px;
      top: 8px;
      z-index: 10;
      background:#131313;
      border:1px solid #333;
      color:#bfe0ff;
      border-radius:8px;
      padding:.4rem .7rem;
      cursor:pointer;
    }

    .back-btn[disabled]{ opacity: .35; cursor: not-allowed; }
    .back-btn:focus-visible { outline: 2px solid #7fb7ff; outline-offset: 2px; }
  </style>
</head>
<body>
  <!-- é”®ç›˜æ— éšœç¢ï¼šæŒ‰é’®å¯å›é€€ä¸Šä¸€æ®µ -->
  <button id="backBtn" class="back-btn" aria-label="è¿”å›ä¸Šä¸€æ­¥" disabled type="button">â† è¿”å›</button>
  <!-- éŸ³ä¹æ’­æ”¾ -->
  <button id="musicBtn" class="music-btn" type="button">ğŸµ éŸ³ä¹</button>

  <!-- å›ºå®šè§†å£å±‚ï¼Œæ‰€æœ‰å¯è§å†…å®¹éƒ½æ”¾è¿™é‡Œ -->
  <div id="viewport" class="viewport">
    <div id="stage" class="stage">
      <!-- aria-live è®©è¯»å±å™¨åœ¨ç‰‡æ®µåˆ‡æ¢æ—¶æœ—è¯»æ–°å†…å®¹ï¼›role=group è¯­ä¹‰åˆ†ç»„ -->
      <div id="app" class="scene" aria-live="polite" role="group"></div>
    </div>
  </div>

  <audio id="bgm" src="å½’å¢Ÿ.mp3" preload="auto" loop></audio>

  <script>
    /* =========================================================
       æ•°æ®ï¼šæ®µè½ä¸é€‰é¡¹ï¼ˆä¿¡ä»»è‡ªæœ‰å†…å®¹ï¼Œå¯å« HTMLï¼‰
       è¯´æ˜ï¼š
       - æ–‡æ¡ˆå¯èƒ½åŒ…å« HTMLï¼ˆå¦‚ <em>/<b>ï¼‰ï¼Œæ¸²æŸ“æ—¶ä¼šç›´æ¥æ³¨å…¥ã€‚
       - å¦‚éœ€é˜²æ­¢å¤–éƒ¨æ³¨å…¥ï¼Œè¯·ç¡®ä¿ PASSAGES ç”±å¯ä¿¡æºæ„å»ºã€‚
       ========================================================= */
    const PASSAGES = {
      /* ===== å¼•å­ä¸ä¸‰é€‰ï¼ˆå­¦æ ¡ / å•ä½ / å®¶ï¼‰ ===== */
      intro0: {
        lines: [
          { text: "å¦‚æœä½ çªç„¶æ¥åˆ°ä¸€ä¸ªç†Ÿæ‚‰åˆé™Œç”Ÿçš„åœ°æ–¹ã€‚" },
          { text: "ä½ ä¼¼æ›¾ç›¸è¯†çš„æ¥¼å°±è¿™æ ·ï¼Œå››å‘¨æ²¡æœ‰ä¸€æ£µæ ‘ï¼Œæ²¡æœ‰ä¸€æœµèŠ±ï¼Œç”šè‡³æ²¡æœ‰ä¸€æ ¹è‰ã€‚æ²¡æœ‰äººï¼Œä¹Ÿæ²¡æœ‰ç‹—ï¼›æ²¡æœ‰è‹è‡å’ŒèŸ‘è‚ã€‚ç©ºæ°”é‡Œæ²¡æœ‰ç”Ÿå‘½çš„æ°”æ¯ã€‚" },
          { text: "å†™ç€æœªçŸ¥å­—ç¬¦ç‰ŒåŒ¾çš„ï¼Œä½ æœ€ç†Ÿæ‚‰çš„â€”â€”" }
        ],
        options: [
          { text: "å­¦æ ¡", next: "route_school" },
          { text: "å•ä½", next: "route_work" },
          { text: "å®¶",   next: "route_home" }
        ],
        enter: "t-enter-up"
      },

      /* ===== å­¦æ ¡çº¿ï¼šå®‰é™åˆ°å¤±çœŸ ===== */
      route_school: {
        lines: [
          { text: "æ ¡å›­é‡Œæ ¼å¤–å®‰é™â€”â€”æ²¡æœ‰ç”µå­è®¾å¤‡çš„å—¡é¸£ï¼Œæ²¡æœ‰é£å£°ï¼Œæ²¡æœ‰è€å¸ˆåŒå­¦çš„å–§å“—ã€‚åªæœ‰ä½ çš„è„šæ­¥ã€ä½ çš„å¿ƒè·³ã€ä½ çš„å‘¼å¸ã€‚" },
          { text: "èµ°å»Šç¯å½±è¿Ÿæ»ï¼Œå¥½åƒå…‰ä¹Ÿè¢«å½’æ¡£å…¥æŸç§å¤±æ•ˆçš„æ—¶é—´åº“ã€‚é»‘æ¿ä¸Šç•™ç€ç²‰å°˜ï¼Œå¯æ²¡æœ‰ä»»ä½•ä¸€ç²’å°˜åŸƒåœ¨é£˜ã€‚" }
        ],
        options: [{ text: "â€¦â€¦", next: "converge_void" }]
      },

      /* ===== å•ä½çº¿ï¼šåŠå…¬åŒºçš„å°¸èœ¡è´¨æ„Ÿ ===== */
      route_work: {
        lines: [
          { text: "ä¸€ç¼•éª‡äººçš„è¿å’Œæ„Ÿæ”«ä½äº†ä½ ã€‚" },
          { text: "æ²¡æœ‰äººå£°ã€‚" },
          { text: "æ²¡æœ‰çŠ¬å ã€‚" },
          { text: "æ²¡æœ‰é›€é¸£ã€‚" },
          { text: "ç”šè‡³è¿é£å£°ã€æ ‘å¶çš„é¢¤åŠ¨éƒ½æ¶ˆå¤±å¾—ä¸€å¹²äºŒå‡€ï¼Œå‘¼å¸ä¼¼ä¹ä¹Ÿè¢«è¿Ÿæ»äº†ã€‚æ•´ä¸ªç©ºé—´æ­»ä¸€èˆ¬çš„å¯‚é™ï¼Œä»¿ä½›æ‰€æœ‰æ´»ç‰©éƒ½è¢«å‰¥å¤ºæ®†å°½ã€‚" }
        ],
        options: [{ text: "â€¦â€¦", next: "converge_void" }]
      },

      /* ===== å®¶çº¿ï¼šç†Ÿæ‚‰æˆ¿é—´é‡Œçš„é™Œç”Ÿå¯’æ„ ===== */
      route_home: {
        lines: [
          { text: "ä¸€ç¼•éª‡äººçš„è¿å’Œæ„Ÿæ”«ä½äº†ä½ ã€‚" },
          { text: "æ²¡æœ‰äººå£°ã€‚" },
          { text: "æ²¡æœ‰çŠ¬å ã€‚" },
          { text: "æ²¡æœ‰é›€é¸£ã€‚" },
          { text: "ç”šè‡³è¿é£å£°ã€æ ‘å¶çš„é¢¤åŠ¨éƒ½æ¶ˆå¤±å¾—ä¸€å¹²äºŒå‡€ï¼Œå‘¼å¸ä¼¼ä¹ä¹Ÿè¢«è¿Ÿæ»äº†ã€‚æ•´ä¸ªç©ºé—´æ­»ä¸€èˆ¬çš„å¯‚é™ï¼Œä»¿ä½›æ‰€æœ‰æ´»ç‰©éƒ½è¢«å‰¥å¤ºæ®†å°½ã€‚" }
        ],
        options: [{ text: "â€¦â€¦", next: "converge_void" }]
      },

      /* ===== ä¸‰çº¿å½’ä¸€ï¼šç©ºå£³ä¸–ç•Œ ===== */
      converge_void: {
        lines: [
          { text: "ä½ ç«™åœ¨æœ€ç†Ÿæ‚‰çš„å±‹å­å‰ï¼Œè„šä¸‹æ˜¯ç†Ÿæ‚‰çš„è·¯ï¼Œçœ¼å‰æ˜¯ç†Ÿæ‚‰çš„é—¨å»Šï¼Œå´ç©ºæ— ä¸€äººã€‚" }
        ],
        options: [
          { text: "ç•™åœ¨åŸåœ°", next: "stay_here" },
          { text: "å»æ¢ç´¢",   next: "explore_choice" }
        ]
      },

      /* ===== åŸåœ°åˆ†æ”¯ï¼šæ¶ˆæ¯/ç¡è§‰ ===== */
      stay_here: {
        lines: [
          { text: "ä½ å†³å®šåŸåœ°ç­‰å¾…ï¼ŒåƒæŠŠè‡ªå·±é’‰åœ¨è¿™å—é™æ­¢çš„å½±å­é‡Œã€‚" }
        ],
        options: [
          { text: "æ‹¿å‡ºæ‰‹æœºå‘æ¶ˆæ¯", next: "try_phone" },
          { text: "å°±åœ°èººä¸‹ç¡è§‰",   next: "sleep_here" }
        ]
      },

      try_phone: {
        lines: [
          { text: "ä½ çš„ç¡®ç¿»åˆ°äº†æ‰‹æœºã€‚" },
          { text: "å¯æƒœï¼Œæ‰‹æœºå’Œä¸€åˆ‡ç”µå­è®¾å¤‡éƒ½å¤±çµäº†ï¼Œåƒæ˜¯ä¸€å—å†°å†·çš„ç™½ç –ã€‚" },
          { text: "ä¿¡å·æ ç©ºç©ºå¦‚ä¹Ÿï¼Œæ—¶é—´å­—æ®µåƒè¢«æŠ¹å»çš„ä¼¤å£ã€‚" }
        ],
        options: [
          { text: "åˆ«æ— é€‰æ‹©ï¼Œåªèƒ½å»æ¢ç´¢", next: "explore_choice" }
        ]
      },

      sleep_here: {
        lines: [
          { text: "ä½ å€šç€é—¨å»Šç¼“æ…¢åä¸‹ã€‚å¯‚é™åƒæ˜¯æ¯äº•ï¼Œä½ æŠŠè‡ªå·±å¾€é‡ŒæŠ•ã€‚" }
        ],
        options: [
          { text: "é—­çœ¼å¼ºè¿«å…¥ç¡ï¼ˆç¡ç€ï¼Œç»“å±€ aï¼‰", next: "ending_a" },
          { text: "ç¿»æ¥è¦†å»ï¼Œæ€ä¹ˆéƒ½ç¡ä¸ç€",         next: "explore_choice" }
        ]
      },

      /* ===== æ¢ç´¢åˆ†æ”¯ï¼šè¿›å±‹ / å»å¤–é¢ ===== */
      explore_choice: {
        lines: [
          { text: "ä½ æ·±å¸ä¸€å£æ°”ï¼Œæœé™æ­¢çš„ä¸–ç•Œè¿ˆå‡ºç¬¬ä¸€æ­¥ã€‚" }
        ],
        options: [
          { text: "è¿›å…¥å±‹å†…",   next: "enter_house" },
          { text: "å»å¤–é¢çœ‹çœ‹", next: "go_outside" }
        ]
      },

      /* ===== è¿›å±‹ï¼šç©ºå£³æˆ¿é—´ ===== */
      enter_house: {
        lines: [
          { text: "ä¾æ—§æ˜¯è®°å¿†ä¸­çš„æ ¼å±€ï¼Œå¯å‘¨å›´çš„ä¸–ç•Œå´åƒä¸€å…·ç©ºå£³ï¼Œé™å¾—åå¸¸ï¼Œåƒæ˜¯æ—¶é—´ä¸ç”Ÿå‘½å…¨è¢«ææ–­ï¼Œç•™ä¸‹è’èŠœçš„èº¯å£³ã€‚" },
          { text: "å¢™ä¸Šæ‚¬æŒ‚çš„ç›¸æ¡†åç€å†·ç™½çš„å…‰ï¼Œä½ çœ‹è§è‡ªå·±çš„å½±ï¼Œåªæ˜¯å½±å­æ²¡æœ‰è·Ÿä½ åŒæ­¥â€”â€”å®ƒæ…¢åŠæ‹ã€‚" }
        ],
        options: [
          { text: "æœå¯»å¼‚å¸¸ç‰©å“", next: "inspect_anomaly" },
          { text: "ç¦»å¼€å±‹å­",     next: "go_outside" }
        ]
      },

      /* ===== å¼‚å¸¸ç‰©å“ â†’ åè®®æ¿€æ´» ===== */
      inspect_anomaly: {
        lines: [
          { text: "ä½ åœ¨æŠ½å±‰çš„æœ€åº•å±‚æ‘¸åˆ°ä¸€å†Œè–„è–„çš„å†Œå­ã€‚å°çš®æ²¡æœ‰å­—ï¼ŒæŒ‡å°–ä¸€è§¦ï¼Œå®ƒåƒæ´»äº†ä¸€æ ·å‘¼å¸ã€‚" },
          { html: "ã€åè®®æ¿€æ´»ï¼š<b>å¡ç‰Œæ¸¸æˆ-æ ¸å¿ƒæ¡†æ¶</b>ã€‘" },
          { html: "ã€å¡æ± è½½å…¥ï¼šå‰¯æœ¬ã€Œä»¥å²ä¸ºé‰´ã€ã€‘" },
          { html: "ã€å‰¯æœ¬æ—¶é™ï¼š24:00:00ï¼ˆå€’è®¡æ—¶å¯åŠ¨ï¼‰ã€‘" }
        ],
        options: [
          { text: "æ¥å—",   next: "accept_protocol" },
          { text: "ä¸æ¥å—", next: "refuse_d1" }
        ]
      },

      /* ===== æ¥å— â†’ ç©ºåŸå²è¯—æ®µè½ â†’ ä»»æ„æ•…äº‹ï¼ˆç»“å±€ bï¼‰ ===== */
      accept_protocol: {
        lines: [
          { text: "å†Œé¡µè‡ªè¡Œç¿»å¼€ï¼Œå¢¨ç—•ç¼“ç¼“æµ¸æ¶¦å‡ºä¸€ä¸ªæ—©å·²åç¼©çš„ç‹æœã€‚" },
          { text: "æˆ–äº‘ï¼Œå¤æœ‰äº¡å›½ï¼Œå…¶æ—¶ç™¾å§“å¿½ç»ï¼Œå®«é˜™ç‹¬å­˜ï¼Œå”¯å›ä¸€äººã€‚åŸéƒ­ç©ºè€Œå¸‚äº•ç­ï¼Œä¸‡å®¤æ— äººï¼Œè‰æœ¨çš†å¯‚ã€‚" },
          { text: "å®«ä¸­é’Ÿé¼“å°šé¸£ï¼Œç¬™ç¬›çŠ¹å“ï¼Œèˆå½±å®›ç„¶ã€‚ç„¶è§†ä¹‹ï¼Œåˆ™é¼“æ— æ‰‹å‡»ï¼Œç¬›æ— å£å¹ï¼Œå°ä¸Šæ›´æ— èˆè€…ã€‚" },
          { text: "å›å§‹æƒ§ï¼Œæ—¢ä¹…è€Œå®‰ã€‚ä¹ƒè‡ªä¸ºå²ï¼š" },
          { text: "æ‰§ç¬”æ›°ã€Œç™¾å§“å®‰å±…ï¼Œå››é‡å‡å¹³ã€ï¼›" },
          { text: "ä¸¾æ¨½æ›°ã€Œç¾¤è‡£åŒå®´ï¼Œæ­Œèˆä¸ç»ã€ï¼›" },
          { text: "ç™»å°æ›°ã€Œä¸‡æ°‘é½å‘¼ï¼Œå£°éœ‡å±±æ²³ã€ã€‚" },
          { text: "äºæ˜¯ï¼Œç©ºåŸä¹‹ä¸­ï¼Œç››ä¸–ä¹‹ç¯‡æˆçŸ£ã€‚" },
          { text: "åä¹‹å²å®˜å¾—å…¶ä¹¦ï¼Œè§ˆè€Œéª‡æ›°ï¼šå…¶è¨€éå¦„ã€‚åŸå£é—´è‹¥æœ‰å‘¼å•¸ï¼Œæ®¿é™›ä¸Šè‹¥è§å† è£³ï¼Œè™šå®è«åˆ†ï¼ŒçœŸä¼ªéš¾è¾©ã€‚" },
          { html: "ã€å‰¯æœ¬æç¤ºï¼š<em>è®²ä¸€ä¸ªæ•…äº‹</em>ï¼Œä½¿ã€Œå›ã€å¼€å¿ƒã€‚ã€‘" }
        ],
        options: [
          { text: "è®²ä»»ä½•ä¸€ä¸ªæ•…äº‹ï¼ˆç»“å±€ bï¼‰", next: "ending_b" }
        ]
      },

      /* ===== ä¸æ¥å— â†’ è´¨é—®å¯¹è¯ â†’ å¼ºåˆ¶ç»‘å®š â†’ ä»»æ„æ•…äº‹ï¼ˆç»“å±€ cï¼‰ ===== */
      refuse_d1: {
        lines: [
          { html: "ã€æ£€æµ‹åˆ°æ‹’ç»è¾“å…¥ã€‚ã€‘" },
          { html: "ã€è¯·ç¡®è®¤ï¼šæ˜¯å¦è¿›å…¥å‰¯æœ¬ã€Œä»¥å²ä¸ºé‰´ã€ã€‚ã€‘" }
        ],
        options: [
          { text: "ä½ æ˜¯è°ï¼Ÿä¸»ç¥ã€ç³»ç»Ÿï¼Œè¿˜æ˜¯æŸä¸ªèº²åœ¨å¸·å¹•åæ“çºµçš„å™äº‹è€…ï¼Ÿ", next: "refuse_d2" },
          { text: "â€¦â€¦ç®—äº†ï¼Œæ¥å—ã€‚", next: "accept_protocol" }
        ]
      },

      refuse_d2: {
        lines: [
          { html: "ã€æ— å…³å­—æ®µã€‚ã€‘" },
          { html: "ã€å½“å‰ä»…å¤„ç†ï¼šè¿›å…¥/æ‹’ç»ã€‚ã€‘" }
        ],
        options: [
          { text: "æˆ‘çŸ¥é“ä½ å¬å¾—è§ã€‚å›ç­”æˆ‘ï¼Œä½ æƒ³è¦ä»€ä¹ˆï¼Ÿ", next: "refuse_d3" },
          { text: "â€¦â€¦ç®—äº†ï¼Œæ¥å—ã€‚", next: "accept_protocol" }
        ]
      },

      refuse_d3: {
        lines: [
          { html: "ã€ç›®æ ‡ï¼šè®²ä¸€æ®µ<b>æœ‰è¶£çš„å†å²</b>ï¼Œä½¿ã€Œå›ã€æ„‰æ‚¦ã€‚ã€‘" },
          { html: "ã€å®Œæˆåå°†å‘æ”¾ï¼š<b>å­˜ç»­</b>ã€‚ã€‘" }
        ],
        options: [
          { text: "å­˜ç»­ï¼Ÿç”¨â€˜æ´»å‘½â€™åšç­¹ç ä¸æˆ‘äº¤æ˜“ï¼Ÿ", next: "refuse_d4" },
          { text: "â€¦â€¦ç®—äº†ï¼Œæ¥å—ã€‚", next: "accept_protocol" }
        ]
      },

      refuse_d4: {
        lines: [
          { html: "ã€è‹¥ä¸æ‰§è¡Œï¼ŒäºŒåå››å°æ—¶å†…ä½ çš„ç”Ÿç‰©ä½“å¾å°†å½»åº•ç†„ç­ï¼›è‹¥æ‰§è¡Œï¼Œå­˜æ´»æ¦‚ç‡æå‡è‡³ 42%ã€‚ã€‘" }
        ],
        options: [
          { text: "æ‹¯æ•‘ï¼Ÿä½ æ‰€è°“çš„ç››ä¸–ä¸è¿‡æ˜¯ç©ºå£³ã€‚å› æœè°è£ï¼Ÿ", next: "refuse_d5" },
          { text: "â€¦â€¦ç®—äº†ï¼Œæ¥å—ã€‚", next: "accept_protocol" }
        ]
      },

      refuse_d5: {
        lines: [
          { html: "ã€å› ç”±ä½ è¿°ï¼Œæœç”±æˆ‘è£ã€‚æ··ä¹±ä¸å¯å®¹ç•™ã€‚ã€‘" },
          { html: "å¢™é¢ä¸ç©ºæ°”çš„çº¹ç†è½»å¾®æ‰­æ›²ï¼Œåƒè¢«æ°´æ™•å¼€çš„å¢¨ã€‚" }
        ],
        options: [
          { text: "ä½ ç¼ºä»€ä¹ˆï¼Œéœ€è¦ä»æˆ‘è¿™å„¿æ¦¨å–ï¼Ÿ", next: "refuse_bind" },
          { text: "â€¦â€¦ç®—äº†ï¼Œæ¥å—ã€‚", next: "accept_protocol" }
        ]
      },

      /* è§¦å‘å¼ºåˆ¶ç»‘å®š â†’ åªèƒ½è®²æ•…äº‹ï¼ˆç»“å±€ cï¼‰ */
      refuse_bind: {
        lines: [
          { html: "ã€æ‹’ç»æ— æ•ˆã€‚èº«ä»½å·²ç»‘å®šã€‚ã€‘" },
          { html: "ã€å‰¯æœ¬å·²å¼€å¯ï¼Œå‰©ä½™æ—¶é—´ï¼š23:47:11ã€‘" },
          { html: "å¸·å¹•åå†·ç™½çš„æ®¿é˜¶ä¸€å±‚å±‚å±•å¼€ã€‚" }
        ],
        options: [
          { text: "â€¦â€¦è®²ä¸€ä¸ªæ•…äº‹å§ï¼ˆç»“å±€ cï¼‰", next: "ending_c" }
        ]
      },

      /* ===== å»å¤–é¢ï¼šç ´å â†’ å¼ºåˆ¶ç»‘å®š â†’ ä¸‰é€‰ï¼ˆd/e/fï¼‰ ===== */
      go_outside: {
        lines: [
          { text: "è¡—é“åƒä¸€æ¡è¢«æç©ºçš„åŠ¨è„‰ã€‚ä½ å¿½ç„¶ç”Ÿå‡ºä¸€ç§è¿‘ä¹æ®‹å¿çš„å†²åŠ¨ï¼šå‡¡æ˜¯è¿˜èƒ½åŠ¨çš„ï¼Œéƒ½è¯¥è¢«è¿«ç»™å‡ºå›åº”ã€‚" }
        ],
        options: [
          { text: "å¤§è‚†ç ´åï¼ˆç ¸ç¯ã€æ€äº•ç›–ã€æ•²ç¢çª—ï¼‰", next: "rampage_bind" },
          { text: "è¾±éª‚é‚£çœ‹ä¸è§çš„â€œä¸»ç¥â€",            next: "insult_god" }
        ]
      },

      rampage_bind: {
        lines: [
          { text: "ä½ æ‰”å‡ºçŸ³å—ï¼Œç»ç’ƒç‚¸å¼€æˆèŠ±ï¼›ä½ æ•²å‡»è·¯ç¯ï¼Œé‡‘å±å—¡é¸£åƒä»æ°´åº•ä¼ æ¥ã€‚" },
          { text: "å½“ä½ æ’¬èµ·ä¸€å—é’çŸ³ç –æ—¶ï¼Œåœ°ä¸‹éœ²å‡ºä¸€å±‚å†·ç™½çš„è–„è†œï¼Œåƒçš®è‚¤ä¸‹çš„çœ¼ç›ã€‚å®ƒçœ¨äº†ä¸€ä¸‹ã€‚" },
          { html: "ã€æ£€æµ‹åˆ°é«˜å¼ºåº¦å¹²æ‰°ã€‚å‰¯æœ¬ç»‘å®šè§¦å‘ã€‚ã€‘" },
          { html: "ã€å¡æ± è½½å…¥ï¼šå‰¯æœ¬ã€Œä»¥å²ä¸ºé‰´ã€ã€‘" }
        ],
        options: [
          { text: "â€¦â€¦", next: "accept_fuben" }
        ]
      },

      accept_fuben: {
        lines: [
          { text: "æˆ–äº‘ï¼Œå¤æœ‰äº¡å›½ï¼Œå…¶æ—¶ç™¾å§“å¿½ç»ï¼Œå®«é˜™ç‹¬å­˜ï¼Œå”¯å›ä¸€äººã€‚åŸéƒ­ç©ºè€Œå¸‚äº•ç­ï¼Œä¸‡å®¤æ— äººï¼Œè‰æœ¨çš†å¯‚ã€‚" },
          { text: "å®«ä¸­é’Ÿé¼“å°šé¸£ï¼Œç¬™ç¬›çŠ¹å“ï¼Œèˆå½±å®›ç„¶ã€‚ç„¶è§†ä¹‹ï¼Œåˆ™é¼“æ— æ‰‹å‡»ï¼Œç¬›æ— å£å¹ï¼Œå°ä¸Šæ›´æ— èˆè€…ã€‚" },
          { text: "å›å§‹æƒ§ï¼Œæ—¢ä¹…è€Œå®‰ã€‚ä¹ƒè‡ªä¸ºå²ï¼š" },
          { text: "æ‰§ç¬”æ›°ã€Œç™¾å§“å®‰å±…ï¼Œå››é‡å‡å¹³ã€ï¼›" },
          { text: "ä¸¾æ¨½æ›°ã€Œç¾¤è‡£åŒå®´ï¼Œæ­Œèˆä¸ç»ã€ï¼›" },
          { text: "ç™»å°æ›°ã€Œä¸‡æ°‘é½å‘¼ï¼Œå£°éœ‡å±±æ²³ã€ã€‚" },
          { text: "äºæ˜¯ï¼Œç©ºåŸä¹‹ä¸­ï¼Œç››ä¸–ä¹‹ç¯‡æˆçŸ£ã€‚" },
          { text: "åä¹‹å²å®˜å¾—å…¶ä¹¦ï¼Œè§ˆè€Œéª‡æ›°ï¼šå…¶è¨€éå¦„ã€‚åŸå£é—´è‹¥æœ‰å‘¼å•¸ï¼Œæ®¿é™›ä¸Šè‹¥è§å† è£³ï¼Œè™šå®è«åˆ†ï¼ŒçœŸä¼ªéš¾è¾©ã€‚" }
        ],
        options: [
          { text: "â€¦â€¦", next: "accept_qieye" }
        ]
      },

      accept_qieye: {
        lines: [
          { html: "ã€å‰¯æœ¬æç¤ºï¼š<em>è®²ä¸€ä¸ªæ•…äº‹</em>ï¼Œä½¿ã€Œå›ã€å¼€å¿ƒã€‚ã€‘" }
        ],
        options: [
          { text: "è®¤çœŸè®²è¿°è‡ªå·±çš„æ•…äº‹ï¼ˆç»“å±€ dï¼‰",     next: "ending_d" },
          { text: "è®²ä¸€ä¸ªâ€œæœ‰è¶£â€çš„ç«¥è¯/è‰ºæœ¯æ€§æ•…äº‹ï¼ˆç»“å±€ eï¼‰", next: "ending_e" },
          { text: "ä¸è®²æ•…äº‹ï¼Œå°è¯•æ”»å‡»â€œå›â€ï¼ˆç»“å±€ fï¼‰",     next: "ending_f" }
        ]
      },

      /* ===== ä¾®è¾±ä¸»ç¥ â†’ ä»è¢«ç»‘å®š â†’ å…ˆèµ°å‰¯æœ¬æ•…äº‹ â†’ å†é€‰ g/h ===== */
      insult_god: {
        lines: [
          { text: "ä½ ä»°å¤´å‘ç©ºæ— çš„ç©¹é¡¶ç—›éª‚ï¼ŒæŠŠæ‰€æœ‰ç²—é„™çš„è¯éƒ½ç¿»å‡ºæ¥ã€‚" },
          { html: "ã€è¯­è¨€æ”¶å½•å®Œæ¯•ã€‚æƒ…ç»ªå‚æ•°ï¼šé«˜ã€‚ã€‘" },
          { html: "ã€å‰¯æœ¬ç»‘å®šå®Œæˆã€‚ã€‘" },
          { html: "ã€å‰¯æœ¬æç¤ºï¼šè®²è¿°ä»¥é‡å»ºå› æœã€‚ã€‘" }
        ],
        options: [
          { text: "â€¦â€¦", next: "insult_story_intro" }
        ]
      },

      /* â€”â€” å±•ç¤ºå‰¯æœ¬æ•…äº‹â€”â€” */
      insult_story_intro: {
        lines: [
          { text: "æˆ–äº‘ï¼Œå¤æœ‰äº¡å›½ï¼Œå…¶æ—¶ç™¾å§“å¿½ç»ï¼Œå®«é˜™ç‹¬å­˜ï¼Œå”¯å›ä¸€äººã€‚åŸéƒ­ç©ºè€Œå¸‚äº•ç­ï¼Œä¸‡å®¤æ— äººï¼Œè‰æœ¨çš†å¯‚ã€‚" },
          { text: "å®«ä¸­é’Ÿé¼“å°šé¸£ï¼Œç¬™ç¬›çŠ¹å“ï¼Œèˆå½±å®›ç„¶ã€‚ç„¶è§†ä¹‹ï¼Œåˆ™é¼“æ— æ‰‹å‡»ï¼Œç¬›æ— å£å¹ï¼Œå°ä¸Šæ›´æ— èˆè€…ã€‚" },
          { text: "å›å§‹æƒ§ï¼Œæ—¢ä¹…è€Œå®‰ã€‚ä¹ƒè‡ªä¸ºå²ï¼š" },
          { text: "æ‰§ç¬”æ›°ã€Œç™¾å§“å®‰å±…ï¼Œå››é‡å‡å¹³ã€ï¼›" },
          { text: "ä¸¾æ¨½æ›°ã€Œç¾¤è‡£åŒå®´ï¼Œæ­Œèˆä¸ç»ã€ï¼›" },
          { text: "ç™»å°æ›°ã€Œä¸‡æ°‘é½å‘¼ï¼Œå£°éœ‡å±±æ²³ã€ã€‚" },
          { text: "äºæ˜¯ï¼Œç©ºåŸä¹‹ä¸­ï¼Œç››ä¸–ä¹‹ç¯‡æˆçŸ£ã€‚" },
          { text: "åä¹‹å²å®˜å¾—å…¶ä¹¦ï¼Œè§ˆè€Œéª‡æ›°ï¼šå…¶è¨€éå¦„ã€‚åŸå£é—´è‹¥æœ‰å‘¼å•¸ï¼Œæ®¿é™›ä¸Šè‹¥è§å† è£³ï¼Œè™šå®è«åˆ†ï¼ŒçœŸä¼ªéš¾è¾©ã€‚" },
          { html: "ã€å‰¯æœ¬æç¤ºï¼š<em>è®²ä¸€ä¸ªæ•…äº‹</em>ï¼Œä½¿ã€Œå›ã€å¼€å¿ƒã€‚ã€‘" }
        ],
        options: [
          { text: "ä½ å†³å®šä»¥å¦ä¸€ç§æ–¹å¼å¯¹æŠ—ï¼šè®©è’è¯åæ²¡å™äº‹æœ¬èº«ã€‚", next: "insult_story_choice" }
        ],
      },

      /* â€”â€” åœ¨æ•…äº‹å±•ç¤ºåå†ç»™â€œç¾è€»/è’å”â€çš„é€‰æ‹© â€”â€” */
      insult_story_choice: {
        lines: [
          { text: "å¸·å¹•åçš„äººå½±é™å¬ã€‚ä½ çš„è¯­è¨€åƒå¾€æ·±äº•é‡ŒæŠ•çŸ³ï¼Œå›å£°æ¥å¾—å¾ˆæ…¢ã€‚" },
          { text: "ä½ ä¸æ‰“ç®—å®‰æŠšå®ƒï¼Œè€Œæ˜¯è®©è’è¯å»æ’•æ‰¯å™äº‹çš„ç¼çº¿ã€‚" }
        ],
        options: [
          { text: "åšä¸€ä»¶ç¾è€»ä¸”æ— æ„ä¹‰çš„äº‹ï¼ˆç»“å±€ gï¼‰", next: "ending_g" },
          { text: "åšä¸€ä»¶è’å”ä½†æ— ä¼¤çš„äº‹ï¼ˆç»“å±€ hï¼‰",   next: "ending_h" }
        ]
      },

      /* ======= å®Œæ•´çš„ 8 ä¸ªç»“å±€ + è·å¾—èŒä¸š ======= */
      ending_a: {
        lines: [
          { text: "ã€ç»“å±€ Aï½œæ²‰ç¡å›å£°ã€‘ä½ é åœ¨å†°å†·çš„é—¨å»Šæ…¢æ…¢ç¡å»ã€‚æ¢¦ä¸­ï¼Œæœ‰äººåœ¨ä½ è€³è¾¹è½»å£°å¤è¿°ä½ è¯´è¿‡çš„æ¯ä¸€å¥è¯ï¼Œåƒæ˜¯æµ·æ°´ä¸€å±‚å±‚å·èµ°æ²™æ»©ä¸Šçš„è„šå°ã€‚" },
          { text: "å½“ä½ å†æ¬¡ççœ¼ï¼Œèƒ¸è…”ç©ºå¾—åƒè¢«äººæ¬èµ°è¿‡ï¼Œåœ°é¢ä¸Šå´ç•™ä¸‹ä¸€åœˆæµ…ç™½çš„ç›ç—•ã€‚æ—¶é—´ä»åœ¨æµé€ï¼Œä½†ä¸–ç•Œå¥½åƒé»˜è®¸äº†ä½ å†æ´»ä¸€æ¬¡ã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šå›å£°æŠ„å†™å‘˜", next: "job_scribe" }
        ]
      },

      ending_b: {
        lines: [
          { text: "ã€ç»“å±€ Bï½œç©ºåŸå¥æŠ˜ã€‘ä½ ç¼“ç¼“è®²å®Œé‚£ä¸ªæ•…äº‹ã€‚å¸·å¹•åçš„äººå½±åƒåœ¨ç¿»é˜…æ—§å·å®—ï¼Œæœ€ç»ˆè½»è½»ç‚¹å¤´ã€‚é’Ÿé¼“å£°ä¸æ˜¯èµç¾ï¼Œä¹Ÿä¸æ˜¯åŒæƒ…ï¼Œè€Œåƒæ˜¯ç›–ä¸‹çš„ä¸€æšå†·é™å°ç« ã€‚" },
          { text: "ä¸–ç•Œçš„äº®åº¦å¾®å¾®ä¸Šå‡ï¼Œä½ è·å¾—äº†ä¸€çº¿ç»§ç»­ä¹¦å†™çš„è®¸å¯ã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šå¾¡è¯è®²å®˜", next: "job_orator" }
        ]
      },

      ending_c: {
        lines: [
          { text: "ã€ç»“å±€ Cï½œè¢«è¿«çš„ç‹¬ç™½ã€‘æ— è®ºä½ æ€æ ·åæŠ—ï¼Œç»‘å®šä»ç„¶å‘ç”Ÿã€‚è¯è¯­åƒä»é½¿ç¼ä¸­è¢«æŠ½å‡ºçš„ä¸€ç¼•ç¼•ä¸çº¿ï¼Œè¶Šæ¥è¶Šé•¿ï¼Œæœ€ç»ˆç»‡æˆå¹•å¸ƒéš”å¼€äº†ä½ å’Œè‡ªå·±ã€‚" },
          { text: "ä½ ç«™åœ¨å¹•å¸ƒä¹‹å‰ï¼Œå¹•å¸ƒå¦ä¸€è¾¹çš„äººå½±ä¸è‡ªå·±é‡å ï¼Œå´å†æ— æ³•ç¡®è®¤é‚£æ˜¯ä¸æ˜¯ä½ ã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šå¥‘çº¦è¡Œèµ°è€…", next: "job_binder" }
        ]
      },

      ending_d: {
        lines: [
          { text: "ã€ç»“å±€ Dï½œé•œé¢å¯¹è¯»ã€‘ä½ é€‰æ‹©è®¤çœŸåœ°è¯‰è¯´è‡ªå·±çš„ç»å†ã€‚å¸·åçš„å½±åƒåƒæ˜¯è¢«é›¾æ°”è’™ä¸Šä¸€å±‚ç™½éœœï¼Œç¼“ç¼“èµ·ä¼ï¼Œä»¿ä½›åœ¨è½»è½»å‘¼å¸ã€‚" },
          { text: "é›¾æ•£ä¹‹åï¼Œé•œé¢é‡Œå‡ºç°äº†ä¸€ä¸ªæ¸©æš–çš„å…‰ç‚¹ã€‚é‚£æ˜¯å±äºä½ çš„æ—¶é—´ï¼Œè¢«ä½ äº‰å–äº†ä¸‹æ¥ã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šé•œé¢å®ˆæœ›è€…", next: "job_mirror" }
        ]
      },

      ending_e: {
        lines: [
          { text: "ã€ç»“å±€ Eï½œç‰ä¸Šçš„ç¬‘çº¹ã€‘ä½ è®²äº†ä¸€ä¸ªæç¾çš„ç«¥è¯ã€‚å›ç¬‘äº†ï¼Œé‚£ç¬‘æ„åƒè¢«é›•åˆ»åœ¨ç‰çŸ³ä¸Šçš„ç»†çº¹ï¼Œæ°¸ä¸æ¶ˆå¤±ï¼Œä¹Ÿæ°¸ä¸å†ç”Ÿé•¿ã€‚" },
          { text: "ä¸–ç•Œå˜å¾—æ›´åŠ å…‰æ»‘ï¼Œä»¿ä½›å†æ²¡æœ‰æ£±è§’ï¼Œä½†ä½ ä¹Ÿå‘ç°è‡ªå·±æ›´éš¾æŠ“ä½å®ƒäº†ã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šç»£è¯é€ æ¢¦å¸ˆ", next: "job_fabulist" }
        ]
      },

      ending_f: {
        lines: [
          { text: "ã€ç»“å±€ Fï½œè¨€å…ˆäºæ‹³ã€‘ä½ è¯•å›¾æŒ¥å‡ºæ‹³å¤´ï¼Œä½†è¯­è¨€æ¯”æ‹³å¤´æ›´å¿«ã€‚å®ƒæ›¿ä½ æ‰“å‡ºç¬¬ä¸€å‡»ï¼Œä¹Ÿæ›¿ä½ ç¼´æ¢°ã€‚" },
          { text: "æ‹³å¤´åœåœ¨åŠç©ºï¼Œåƒä¸€æšå­¤é›¶é›¶çš„æ ‡ç‚¹ç¬¦å·ï¼Œè€Œä½ çš„å¥å­ç»§ç»­æ›¿ä½ å®Œæˆäº†åå‡»ä¸å¦¥åã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šè¾©æ–—å®¶", next: "job_brawler" }
        ]
      },

      ending_g: {
        lines: [
          { text: "ã€ç»“å±€ Gï½œç¾è€»å­˜æ¡£ã€‘ä½ æŠŠç¾è€»å½“ä½œæ­¦å™¨å»åˆºç ´è§„åˆ™ã€‚è§„åˆ™å´åªæ˜¯å®‰é™åœ°è®°å½•ï¼šå®ƒæŠŠä½ é€å­—æŠ„ä¸‹ï¼Œæ”¾è¿›å†·æŸœï¼Œè´´ä¸Šç¼–å·å’Œæ—¥æœŸã€‚" },
          { text: "ä½ é€è¿‡å†°å†·çš„ç»ç’ƒçœ‹è§è‡ªå·±ï¼Œå†»å¾—é€šçº¢ï¼Œå´ä¾æ—§æ¸…é†’åœ°å‘¼å¸ã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šå†·æŸœæ¡£æ¡ˆå¸ˆ", next: "job_archivist" }
        ]
      },

      ending_h: {
        lines: [
          { text: "ã€ç»“å±€ Hï½œè’å”è¯æ¡ã€‘ä½ ç”¨å½»åº•çš„è’å”å›åº”è’å”æœ¬èº«ã€‚æ®¿ä¸­çš„å½±å­é™é™çœ‹ç€ï¼Œåƒæ˜¯å­¦ä¼šäº†ä¸€ä¸ªæ–°è¯ï¼ŒæŠŠå®ƒå†™è¿›å­—å…¸ï¼Œå¹¶åœ¨æ³¨é‡Šå¤„å†™ä¸‹ä½ çš„åå­—ã€‚" },
          { text: "è¯æ¡ä¸‹æ–¹è¿˜æœ‰ä¸€è¡Œå°å­—ï¼šã€å¯å¤ç”¨ã€ã€‚" }
        ],
        options: [
          { text: "è·å¾—èŒä¸šï¼šè’è¯æ³¨é‡Šè€…", next: "job_glossator" }
        ]
      }

      /* === æç¤ºï¼šä½ åœ¨ç»“å±€åçš„â€œèŒä¸šâ€æ®µè½ï¼ˆjob_*ï¼‰å¯ç»§ç»­è¡¥å…… === */
    };

    /* =========================================================
       çŠ¶æ€ä¸å¼•ç”¨
       ========================================================= */
    const app = document.getElementById('app');
    const stage = document.getElementById('stage');
    const viewport = document.getElementById('viewport');
    const backBtn = document.getElementById('backBtn');

    const STATE = {
      currentId: null,
      busy: false,
      history: []
    };

    // å…¼å®¹æ—§æ¸²æŸ“é€»è¾‘ï¼šshow() é‡Œä»ä½¿ç”¨ P[id]
    const P = PASSAGES;

    /* =========================================================
       å·¥å…·ï¼šå®‰å…¨åœ°å†™å…¥ --vh ä»¥ç¨³å®šç§»åŠ¨ç«¯è§†å£é«˜åº¦
       ========================================================= */
    function updateVHVar(){
      // ä½¿ç”¨ window.innerHeight æ›´è´´è¿‘è§†è§‰è§†å£
      const vh = window.innerHeight / 100;
      document.documentElement.style.setProperty('--vh', vh + 'px');
    }

    /* =========================================================
       æ¸²æŸ“ä¸»æµç¨‹
       - show(id): åˆ‡æ¢æ®µè½ï¼ˆå¸¦ç¦»åœº/å…¥åœºåŠ¨ç”»ï¼‰
       - mount(passage): ç”ŸæˆèŠ‚ç‚¹å¹¶æŒ‚è½½
       - renderOptions(opts): é€‰é¡¹æ¸²æŸ“ä¸ºå¯ç‚¹å‡»é“¾æ¥
       ========================================================= */
    function show(id, leaveAnim = "t-leave-left") {
      if (STATE.busy) return;
      STATE.busy = true;

      try {
        const next = P[id];
        if (!next) {
          console.warn("æœªçŸ¥æ®µè½ï¼š", id);
          return;
        }

        const enterClass = next.enter || "t-enter";

        if (app.firstChild) {
          const old = app.firstChild;
          old.classList.add(leaveAnim);
          old.addEventListener("animationend", () => {
            // ç§»é™¤æ—§èŠ‚ç‚¹åå†æŒ‚è½½æ–°èŠ‚ç‚¹
            if (old.parentNode === app) app.removeChild(old);
            mount(next, enterClass);
          }, { once: true });
        } else {
          mount(next, enterClass);
        }

        STATE.currentId = id;
        updateBackBtn();
      } finally {
        // æ³¨æ„ï¼šæœ€ç»ˆçš„ busy=false æ”¾åœ¨ mount çš„åŠ¨ç”»ç»“æŸå›è°ƒä¸­
        // è¿™é‡Œä¸èƒ½ç«‹å³å¤ä½ï¼Œå¦åˆ™ä¼šæ‰“æ–­åŠ¨ç”»æœŸé—´çš„èŠ‚æµ
      }
    }

    function mount(passage, enterClass) {
      const box = document.createElement("div");
      box.className = enterClass + " muted";

      // å…¼å®¹ä¸‰ç§å†™æ³•ï¼šlinesï¼ˆæ–°ï¼‰ã€htmlã€textï¼ˆæ—§ï¼‰
      let content = "";
      if (Array.isArray(passage.lines)) {
        content = passage.lines.map(l => {
          if (!l) return "<p></p>";
          if (l.html != null) return `<p>${l.html}</p>`;
          return `<p>${l.text ? l.text : ""}</p>`;
        }).join("");
      } else if (passage.html != null) {
        content = passage.html;
      } else if (passage.text != null) {
        content = `<p>${passage.text}</p>`;
      }

      box.innerHTML = content + renderOptions(passage.options);

      // äº‹ä»¶å§”æ‰˜ï¼šç‚¹å‡»é€‰é¡¹
      box.addEventListener("click", (e) => {
        const a = e.target.closest("a[data-next]");
        if (!a) return;
        e.preventDefault();

        const nextId = a.dataset.next;
        if (STATE.currentId) STATE.history.push(STATE.currentId);
        show(nextId);
      });

      // é”®ç›˜å¯è¾¾æ€§ï¼šåœ¨å½“å‰ card å†…ç”¨ä¸Šä¸‹æ–¹å‘é”®/å›è½¦è¿›è¡Œå¯¼èˆªï¼ˆå¯é€‰å¢å¼ºï¼‰
      box.addEventListener("keydown", (e) => {
        const links = box.querySelectorAll('a[data-next]');
        if (!links.length) return;

        const currentIndex = Array.prototype.indexOf.call(links, document.activeElement);
        if (e.key === "ArrowDown") {
          e.preventDefault();
          const next = links[Math.min(currentIndex + 1, links.length - 1)] || links[0];
          next.focus();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          const prev = links[Math.max(currentIndex - 1, 0)] || links[links.length - 1];
          prev.focus();
        } else if (e.key === "Enter" && document.activeElement?.hasAttribute('data-next')) {
          e.preventDefault();
          document.activeElement.click();
        }
      });

      app.appendChild(box);

      // å…¥åœºåŠ¨ç”»ç»“æŸåï¼š
      box.addEventListener("animationend", () => {
        box.classList.remove("muted");
        STATE.busy = false;
        fitStage();            // å†…å®¹å˜åŒ–åè®¡ç®—ä¸€æ¬¡ç¼©æ”¾
        focusFirstOption(box); // è¾…åŠ©æ— éšœç¢ï¼šå°†ç„¦ç‚¹ç§»åˆ°ç¬¬ä¸€é¡¹/å®¹å™¨
      }, { once: true });
    }

    function renderOptions(opts = []) {
      if (!opts.length) return "";
      return `<div>${opts.map(o => `<a href="#" data-next="${o.next}">${o.text}</a>`).join("")}</div>`;
    }

    function focusFirstOption(container){
      const firstLink = container.querySelector('a[data-next]');
      if (firstLink) {
        // å»¶åä¸€å¸§ï¼Œç¡®ä¿æ¸²æŸ“å®Œæˆåå†èšç„¦
        requestAnimationFrame(() => firstLink.focus());
      } else {
        // è‹¥æ²¡æœ‰é€‰é¡¹ï¼Œèšç„¦åˆ°å®¹å™¨ä»¥ä¾¿è¯»å±å™¨å®£è¯»
        container.setAttribute('tabindex', '-1');
        requestAnimationFrame(() => container.focus());
      }
    }

    /* =========================================================
       å¯¼èˆªï¼šè¿”å›ä¸Šä¸€æ®µ
       - Backspace/Alt+Left æ”¯æŒï¼ˆé¿å…åœ¨è¾“å…¥æ¡†å†…è¯¯è§¦ï¼‰
       ========================================================= */
    function goBack(){
      if (STATE.busy || STATE.history.length === 0) return;
      const prevId = STATE.history.pop();
      show(prevId, "t-leave");
    }

    backBtn.addEventListener('click', goBack);

    document.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      const isTyping = tag === 'input' || tag === 'textarea' || e.target.isContentEditable;

      if (isTyping) return; // è¾“å…¥æ—¶ä¸æ‹¦æˆª

      // Backspace è¿”å›
      if (e.key === 'Backspace') {
        e.preventDefault();
        goBack();
      }

      // Alt + å·¦æ–¹å‘ è¿”å›ï¼ˆæ¥è¿‘æµè§ˆå™¨ä¹ æƒ¯ï¼Œä½†åªå½±å“ç«™å†…ï¼‰
      if (e.altKey && e.key === 'ArrowLeft') {
        e.preventDefault();
        goBack();
      }
    }, { passive: false });

    function updateBackBtn(){
      backBtn.disabled = STATE.history.length === 0;
      backBtn.setAttribute('aria-disabled', String(backBtn.disabled));
    }

    /* =========================================================
       è§†å£ä¸ç¼©æ”¾ï¼ˆé›¶æ»šåŠ¨å…³é”®ï¼‰
       - æ ¹æ® .viewport å†…å®¹åŒºé«˜åº¦ï¼Œç­‰æ¯”ç¼©æ”¾ .stageï¼Œä½¿å…¶å®Œå…¨å®¹çº³
       - scale çš„ä¸‹é™ä¸Šé™é˜²æŠ–ï¼Œé¿å…æç«¯ç¼©å°/æ”¾å¤§é€ æˆè§†è§‰é—®é¢˜
       ========================================================= */
    let rafId = 0;
    function fitStage(){
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(() => {
        const styles = getComputedStyle(viewport);
        const pt = parseFloat(styles.paddingTop) || 0;
        const pb = parseFloat(styles.paddingBottom) || 0;
        const availableH = viewport.clientHeight - pt - pb;

        // å…ˆå¤ä½ scaleï¼Œæµ‹é‡åŸå§‹é«˜åº¦
        stage.style.transform = 'scale(1)';
        const contentH = stage.getBoundingClientRect().height;

        // è®¡ç®—æ¯”ä¾‹ï¼Œé™åˆ¶åŒºé—´ [0.5, 1]ï¼Œå¹¶ç•™ 2% ä½™é‡
        const scale = Math.min(1, Math.max(0.5, (availableH / contentH) * 0.98));
        stage.style.transform = `scale(${scale})`;
      });
    }

    /* =========================================================
       ç›‘å¬å°ºå¯¸ä¸æ–¹å‘å˜åŒ–ï¼ˆèŠ‚æµåˆ°ä¸€å¸§ï¼‰
       - ä½¿ç”¨ ResizeObserver ç›‘å¬æ ¹å…ƒç´ å°ºå¯¸å˜æ›´
       - å åŠ  window resize / orientationchange ä½œä¸ºå†—ä½™
       ========================================================= */
    const ro = ('ResizeObserver' in window)
      ? new ResizeObserver(() => { updateVHVar(); fitStage(); })
      : null;

    if (ro) ro.observe(document.documentElement);

    window.addEventListener('orientationchange', () => { updateVHVar(); fitStage(); }, { passive: true });
    window.addEventListener('resize', () => { updateVHVar(); fitStage(); }, { passive: true });

    /* =========================================================
       å¯åŠ¨ï¼šå†™å…¥ --vhã€è¿›å…¥èµ·å§‹æ®µè½ã€é¦–æ¬¡é€‚é…ç¼©æ”¾
       ========================================================= */
    updateVHVar();
    show("intro0");   // ä» intro0 å¼€å§‹
    fitStage();

    // è¡¥å……ï¼šé¡µé¢å¯è§æ€§å˜æ›´æ—¶å¾®è°ƒä¸€æ¬¡ï¼ˆç§»åŠ¨ç«¯ä»åå°å›å‰å°å¯èƒ½æœ‰åœ°å€æ å˜åŒ–ï¼‰
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        updateVHVar(); fitStage();
      }
    });

    /* =========================================================
   èƒŒæ™¯éŸ³ä¹ï¼šè‡ªåŠ¨æ’­æ”¾ + å…œåº•äº¤äº’æ’­æ”¾
   ========================================================= */
const bgm = document.getElementById('bgm');
const musicBtn = document.getElementById('musicBtn');

// å°è¯•è‡ªåŠ¨æ’­æ”¾
function tryAutoPlay() {
  if (!bgm) return;
  bgm.volume = 0.6;
  const playPromise = bgm.play();
  if (playPromise !== undefined) {
    playPromise.catch(() => {
      // è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·ç¬¬ä¸€æ¬¡äº¤äº’
    });
  }
}

// é¡µé¢é¦–æ¬¡åŠ è½½å°è¯•
tryAutoPlay();

// ä»»æ„ä¸€æ¬¡ç”¨æˆ·ç‚¹å‡»åï¼Œç¡®ä¿æ’­æ”¾
document.addEventListener('click', function oncePlay() {
  tryAutoPlay();
  document.removeEventListener('click', oncePlay);
});

// éŸ³ä¹æŒ‰é’®ï¼šæš‚åœ / æ’­æ”¾åˆ‡æ¢
musicBtn.addEventListener('click', () => {
  if (bgm.paused) {
    bgm.play();
    musicBtn.textContent = 'â¸ æš‚åœ';
  } else {
    bgm.pause();
    musicBtn.textContent = 'ğŸµ éŸ³ä¹';
  }
});


  </script>
</body>
</html>
